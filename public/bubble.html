<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Cards assigned by member</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script src="js/bubble.js"></script>
  <script src="js/login.js"></script>
  <script src="js/trello-utils.js"></script>

  <script src="https://trello.com/1/client.js?key=870c6e671ccf7a24104558904ab7795c"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

</head>
<body>

<!-- HEADER -->
<div w3-include-html="header.html"></div>
<!-- HEADER -->

<!-- MAIN -->
<main>
  <div class="section no-pad-bot" id="index-banner">
    <div class="container">
      <br><br>
      <h1 class="header center globant-orange-text">Cards assigned by member</h1>
      <div class="row center">
        <svg width="800" height="800" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
      </div>
    </div>
  </div>

<script>
  var svg = d3.select("svg");
  var width = +svg.attr("width");
  var height = +svg.attr("height");
  var format = d3.format(",d");
  var color = d3.scaleOrdinal(d3.schemeCategory20c);
  var pack = d3.pack()
    .size([width - 4, height - 4]);
  var radius = d3.scaleSqrt()
      .range([0, 15]);

  var boardId = localStorage.getItem("boardId");
  if (boardId == undefined || boardId == "undefined") {
    // default to SWA Dallas ET
    boardId = "59b1586d844575c1675e5413";
  }
  var members_json_url = "https://api.trello.com/1/boards/" + boardId + "/cards/all/?"
    + "key=870c6e671ccf7a24104558904ab7795c"
    + "&token=" + localStorage.getItem("trello_token")
    + "&fields=members"
    + "&members=true";

  d3.json(members_json_url, function(error, cards) {
    if (error) throw error;

    var members = getMembersFromCards(cards);
    var root = d3.hierarchy({children: members})
      .sum(function(d) { return d.value; });

    var node = svg.selectAll(".node")
      .data(pack(root).leaves())
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

    node.append("circle")
      .attr("id", function(d) { return d.data.name; })
      .attr("r", function(d) { return radius(d.data.value == undefined ? 1 : d.data.value * 10); })
      .style("fill", function(d) { return color(d.data.name); })
      .on("mouseover", function(d) {
              tooltip.text(format(d.value));
              tooltip.style("visibility", "visible");
      })
      .on("mousemove", function() {
          return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");
      })
      .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

    node.append("text")
      .text(function(d) { return d.data.name; });

    var tooltip = d3.select("body")
      .append("div")
      .style("position", "absolute")
      .style("z-index", "10")
      .style("visibility", "hidden")
      .style("color", "white")
      .style("padding", "8px")
      .style("background-color", "rgba(0, 0, 0, 0.75)")
      .style("border-radius", "6px")
      .style("font", "12px sans-serif")
      .text("tooltip");
  });
</script>
</main>
<!-- MAIN -->

<!-- FOOTER -->
<div w3-include-html="footer.html"></div>
<!-- FOOTER -->

<script>
w3.includeHTML(processToken);
</script>
</body>
</html>

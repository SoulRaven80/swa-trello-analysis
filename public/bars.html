<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <title>Label distributions</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="css/bars.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="https://www.w3schools.com/lib/w3.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script src="js/bars.js"></script>
  <script src="js/login.js"></script>
  <script src="js/trello-utils.js"></script>
  <script src="js/utils.js"></script>

  <script src="https://trello.com/1/client.js?key=870c6e671ccf7a24104558904ab7795c"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<body>
  <!-- HEADER -->
  <div w3-include-html="header.html"></div>
  <!-- HEADER -->

  <!-- MAIN -->
  <main>
    <div class="section no-pad-bot" id="index-banner">
      <div class="container">
        <h1 class="header center globant-orange-text">Label distributions</h1>
        <div class="row center">
          <br />
          <form action="#">
            <input class="with-gap" type="radio" name="cardsMode" id="allCards" value="allCards" checked />
            <label for="allCards">All cards</label>
            <input class="with-gap" type="radio" name="cardsMode" id="openCards" value="openCards" />
            <label for="openCards">Only open cards</label>
          </form>
          <br />
          <svg width="800" height="500" font-family="sans-serif" font-size="10" text-anchor="middle"></svg>
          <br /><br />
        </div>
      </div>
    </div>

<script>
  var svg = d3.select("svg"),
      margin = {top: 20, right: 20, bottom: 30, left: 40},
      width = +svg.attr("width") - margin.left - margin.right,
      height = +svg.attr("height") - margin.top - margin.bottom;

  var x = d3.scaleBand().rangeRound([0, width]).padding(0.1),
      y = d3.scaleLinear().rangeRound([height, 0]);

  d3.json(getJsonURLforAllCards("closed,name,labels", false), function(error, cards) {
      if (error) throw error;

    var filteredData = countAllCardsPerLabel(cards);
    var maxValue = d3.max(filteredData, function(d) { return d.value; });

    draw(filteredData);

    function draw(data) {
      x.domain(data.map(function(d) { return d.name; }));
      y.domain([0, maxValue]);

      $("svg").empty();

      var g = svg.append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      g.append("g")
          .attr("class", "axis axis--x")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x))
          .selectAll("text")
          .call(wrap, x.bandwidth());

      g.append("g")
          .attr("class", "axis axis--y")
          .call(d3.axisLeft(y))
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 6)
          .attr("dy", "0.71em")
          .attr("text-anchor", "end")
          .text("Value");

      var bar = g.selectAll(".bar").data(data);

      bar.enter().append("rect")
          .attr("class", "bar")
          .attr("x", function(d) { return x(d.name); })
          .attr("y", function(d) { return y(d.value); })
          .attr("width", x.bandwidth())
          .attr("height", function(d) { return height - y(d.value); });

      d3.selectAll("input").on("change", changed);

      function changed() {
        console.log("changed");
        var filteredData = filterData(cards);
        draw(filteredData);
      }
    }
  });

  function wrap(text, width) {
    text.each(function() {
      var text = d3.select(this),
          words = text.text().split(/\s+/).reverse(),
          word,
          line = [],
          lineNumber = 0,
          lineHeight = 1.1, // ems
          y = text.attr("y"),
          dy = parseFloat(text.attr("dy")),
          tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
      while (word = words.pop()) {
        line.push(word);
        tspan.text(line.join(" "));
        if (tspan.node().getComputedTextLength() > width) {
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
        }
      }
    });
  }
</script>
</main>
<!-- MAIN -->

<!-- FOOTER -->
<div w3-include-html="footer.html"></div>
<!-- FOOTER -->

<script>
w3.includeHTML(processToken);
</script>
</body>
</html>
